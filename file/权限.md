# 文件权限机制

- 相对固定的权限
  - 个人文件的权限，自己能读写，也可创建具有特定权限的分享链接
  - 团队文件的权限，非团队不可访问，团队成员有只读或读写权限
  - 这类权限使用权限表来控制
- 会随时变化的权限
  - 即一个用户正在编辑某个文件时，其它用户只能以只读形式访问此文件
  - 这类权限使用互斥锁控制（Team.using字段），下文写锁定、上锁解锁指的都是这个

访问文件过程中可能同时涉及类权限，如果两类权限都允许写操作，才能写


## 权限授予流程

<a href="https://imgtu.com/i/XKj6TP"><img src="https://s1.ax1x.com/2022/05/29/XKj6TP.png" alt="XKj6TP.png" border="0" /></a>

## model部分的修改

File中添加了using字段，一个User外键

如果using为None，说明没有目前没有用户编辑此文件

如果using为某个User对象，说明这个User正在编辑

**file/lock.py提供了3个函数，上锁、解锁、查看锁**

## api部分的修改

加上权限机制之后，后端添加了3个api

- create_team_file：创建团队文件
- modify_team_file_perm：修改团队文件权限
- close_file：关闭文件，放弃对文件的锁定

其余api全部沿用之前的，只是会额外做一些事情：

- 所有涉及fileid的操作：会检查文件是否属于团队，以及用户是否也属于这个团队
- read_file：尝试获取写权限，无法获取就提供只读权限
- edit_file：拥有写权限才能保存文件
- delete_file：拥有写权限才能删除文件


## 错误码汇总

| 错误码 | 错误类型                         |
| ------ |------------------------------|
|2101| 试图访问团队文件，但用户不属于这个团队          |
|2103| 试图访问团队文件，但此文件正被其它用户使用        |
|2104| 试图关闭文件，但目前并未持有此文件            |
|2105| 试图对非团队文件做团队文件才支持的操作，比如修改访问权限 |
|2106| 普通成员试图修改团队文件权限|
|2107| 试图将权限修改为不合法的值|
|2108| 创建团队文件，父文件不属于此团队|
|2109| 创建团队文件，但给出了错误的团队名|

## 相关api

### 